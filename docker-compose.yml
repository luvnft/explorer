version: "3.7"

# ======================================================================================================================
# Default network.
networks:
  royllo-explorer-network:
    name: royllo-explorer-network

# ======================================================================================================================
# Volumes - Volumes are the preferred mechanism for persisting data generated by and used by Docker containers.
# You can list them with the command: 'docker volume ls'
volumes:
  royllo-explorer-database-volume:
  royllo-explorer-storage-volume:

# ======================================================================================================================
# Services (Docker images).
services:

  # ====================================================================================================================
  # Database used to store data ( https://hub.docker.com/_/postgres ).
  royllo-explorer-database-server:
    image: library/postgres:16-alpine
    restart: always
    networks:
      - royllo-explorer-network
    ports:
      - "5432:5432"
    volumes:
      - royllo-explorer-database-volume:/var/lib/postgresql/data
    environment:
      - TZ=Europe/Paris
      - PGTZ=Europe/Paris
      - POSTGRES_DB=royllo_explorer_database
      - POSTGRES_USER=royllo_explorer_username
      - POSTGRES_PASSWORD=Q5QnE5S%Y]qt7

  # ====================================================================================================================
  # Storage service used to store content ( https://hub.docker.com/r/minio/minio ).
  royllo-explorer-storage-server:
    image: minio/minio:RELEASE.2024-01-01T16-36-33Z.fips
    restart: always
    networks:
      - royllo-explorer-network
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - royllo-explorer-storage-volume:/data
    environment:
      - TZ=Europe/Paris
      - MINIO_ROOT_USER=royllo
      - MINIO_ROOT_PASSWORD=tTX4LD7gYaQbhZ
    command: server --console-address ":9001" /data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  createRoylloBucket:
    image: minio/mc:RELEASE.2023-12-29T20-15-29Z.fips
    networks:
      - royllo-explorer-network
    depends_on:
      - royllo-explorer-storage-server
    entrypoint: >
      /bin/sh -c "
      sleep 10;
      /usr/bin/mc alias set myminio http://royllo-explorer-storage-server:9000 royllo tTX4LD7gYaQbhZ;
      /usr/bin/mc mb myminio/royllo-explorer;
      /usr/bin/mc anonymous set public myminio/royllo-explorer;
      exit 0;
      "
  # ====================================================================================================================
  # Royllo explorer batch server ( https://hub.docker.com/r/royllo/explorer-batch ).
  royllo-explorer-batch-server:
    image: royllo/explorer-batch:latest
    depends_on:
      - royllo-explorer-database-server
    networks:
      - royllo-explorer-network
    environment:
      - TZ=Europe/Paris
      - ROYLLO_EXPLORER_CONTENT_BASE_URL=http://localhost:9000/royllo-explorer
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_DATASOURCE_URL=jdbc:postgresql://royllo-explorer-database-server/royllo_explorer_database
      - SPRING_DATASOURCE_USERNAME=royllo_explorer_username
      - SPRING_DATASOURCE_PASSWORD=Q5QnE5S%Y]qt7
      - MEMPOOL_API_BASE-URL=https://mempool.space/testnet/api
      - TAPD_API_BASE-URL=https://testnet.universe.royllo.org:8089
      - TAPD_API_MACAROON=0201047461706402A301030A1004650A26E6928A4C60E007BDA107389E1201301A180A09616464726573736573120472656164120577726974651A150A06617373657473120472656164120577726974651A150A066461656D6F6E120472656164120577726974651A130A046D696E74120472656164120577726974651A150A0670726F6F6673120472656164120577726974651A170A08756E6976657273651204726561641205777269746500000620A28CB923A36B8B86E03C47E5275CA31104A6065401227FFD068BC545DFAB383F
      - SPRING_LIQUIBASE_ENABLED=true
      - SPRING_PROFILES_ACTIVE=s3-storage
      - S3_ACCESS_KEY=royllo
      - S3_SECRET_KEY=tTX4LD7gYaQbhZ
      - S3_BUCKET_NAME=royllo-explorer
      - S3_ENDPOINTURL=http://royllo-explorer-storage-server:9000
      - # ====================================================================================================================
      # Royllo explorer API server ( https://hub.docker.com/r/royllo/explorer-api ).
  royllo-explorer-api-server:
    image: royllo/explorer-api:latest
    depends_on:
      - royllo-explorer-batch-server
    networks:
      - royllo-explorer-network
    ports:
      - "9090:8080"
    environment:
      - TZ=Europe/Paris
      - ROYLLO_EXPLORER_CONTENT_BASE_URL=http://localhost:9000/royllo-explorer
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_DATASOURCE_URL=jdbc:postgresql://royllo-explorer-database-server/royllo_explorer_database
      - SPRING_DATASOURCE_USERNAME=royllo_explorer_username
      - SPRING_DATASOURCE_PASSWORD=Q5QnE5S%Y]qt7
      - SPRING_LIQUIBASE_ENABLED=false
      - SPRING_PROFILES_ACTIVE=s3-storage
      - S3_ACCESS_KEY=royllo
      - S3_SECRET_KEY=tTX4LD7gYaQbhZ
      - S3_BUCKET_NAME=royllo-explorer
      - S3_ENDPOINTURL=http://royllo-explorer-storage-server:9000

  # ====================================================================================================================
  # Royllo explorer web server ( https://hub.docker.com/r/royllo/explorer-web ).
  royllo-explorer-web-server:
    image: royllo/explorer-web:latest
    depends_on:
      - royllo-explorer-batch-server
    networks:
      - royllo-explorer-network
    ports:
      - "8080:8080"
    environment:
      - TZ=Europe/Paris
      - ROYLLO_EXPLORER_CONTENT_BASE_URL=http://localhost:9000/royllo-explorer
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_DATASOURCE_URL=jdbc:postgresql://royllo-explorer-database-server/royllo_explorer_database
      - SPRING_DATASOURCE_USERNAME=royllo_explorer_username
      - SPRING_DATASOURCE_PASSWORD=Q5QnE5S%Y]qt7
      - SPRING_LIQUIBASE_ENABLED=false
      - SPRING_PROFILES_ACTIVE=s3-storage
      - S3_ACCESS_KEY=royllo
      - S3_SECRET_KEY=tTX4LD7gYaQbhZ
      - S3_BUCKET_NAME=royllo-explorer
      - S3_ENDPOINTURL=http://royllo-explorer-storage-server:9000
